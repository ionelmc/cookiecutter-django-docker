version: '3.7'

services:
  pg:
    ports:
      - '5432:5432'
  nginx:
    build:
      context: .
      dockerfile: docker/python/Dockerfile
      args:
        REQUIREMENTS: nginx
    environment:
      SERVER_NAME:
      PYTHONHUNTER:
      PYTHONHUNTERCONFIG:
      DJANGO_DEBUG:
      DJANGO_DEBUG_SQL:
      DJANGO_DEBUG_TOOLBAR:
    env_file:
      - .env
    tty: false
    volumes:
      - .:/shared/${SERVER_NAME}
    depends_on:
      - web
    ports:
      - '80:80'
      - '443:443'
    command: [
      'holdup',
      '--verbose', 'unix:///shared/${SERVER_NAME}/run/uwsgi.sock',
      '--',
      'nginx',
    ]
  web:
    environment:
      DJANGO_DB_MIGRATE: x
      DJANGO_COLLECTSTATIC: x
    command: [
      'uwsgi',
      '--ini', '/etc/app/uwsgi.ini',
      '--processes', '4',
    ]
    depends_on:
      - pg
    stop_signal: SIGTERM
    volumes:
      - ./etc:/etc/app
  reloader:
    build:
      context: docker/reloader
    volumes:
      - .:/app
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      RELOADER_MONITOR:
      COMPOSE_PROJECT_NAME:
